name: Deploy to Azure VM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create deployment package
      run: |
        # Create a deployment directory
        mkdir -p deployment
        # Copy necessary files
        cp -r *.js *.json *.html *.css assets deployment/
        cp -r .github deployment/ 2>/dev/null || true
        # Create a zip file for Windows deployment
        zip -r deployment.zip deployment/
        
    - name: Upload deployment package to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        source: "deployment.zip"
        target: "./"
        
    - name: Upload deployment script to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        source: "deploy.ps1"
        target: "./"
        
    - name: Deploy to Azure Windows VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: ${{ secrets.AZURE_VM_USERNAME }}
        password: ${{ secrets.AZURE_VM_PASSWORD }}
        port: ${{ secrets.AZURE_VM_PORT || 22 }}
        envs: MONGODB_URI,DB_NAME,COLLECTION_NAME
        script: |
          $env:MONGODB_URI="${{ secrets.MONGODB_URI }}"
          $env:DB_NAME="${{ secrets.DB_NAME }}"
          $env:COLLECTION_NAME="${{ secrets.COLLECTION_NAME }}"
          powershell -ExecutionPolicy Bypass -File deploy.ps1
          
    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.zip
        retention-days: 1
        
    - name: Cleanup
      run: |
        rm -rf deployment
        rm -f deployment.zip 